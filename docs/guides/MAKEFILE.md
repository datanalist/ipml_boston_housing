# Руководство по использованию Makefile

Это руководство описывает все доступные команды Makefile проекта Boston Housing.

## Содержание

- [Быстрый старт](#быстрый-старт)
- [Основные команды](#основные-команды)
- [DVC команды](#dvc-команды)
- [Интеграция и мониторинг](#интеграция-и-мониторинг)
- [Docker команды](#docker-команды)
- [Airflow команды](#airflow-команды)
- [Работа с данными](#работа-с-данными)
- [ML эксперименты](#ml-эксперименты)
- [Полный пайплайн экспериментов](#полный-пайплайн-экспериментов)
- [Справка](#справка)

## Быстрый старт

### Просмотр всех доступных команд

```bash
make help
```

или просто:

```bash
make
```

### Полная настройка проекта

Создает виртуальное окружение, устанавливает зависимости, настраивает pre-commit хуки, запускает инфраструктуру и загружает данные из DVC:

```bash
make setup
```

После выполнения:
- MLflow UI доступен по адресу: http://localhost:5000
- MinIO Console доступен по адресу: http://localhost:9001

### Быстрый старт

Загружает данные, запускает инфраструктуру и выполняет эксперименты:

```bash
make quickstart
```

После выполнения:
- MLflow UI: http://localhost:5000
- MinIO Console: http://localhost:9001
- Результаты: `data/experiments/results_summary.csv`

## Основные команды

### Установка зависимостей

```bash
make requirements
```

Синхронизирует зависимости проекта с помощью `uv sync`.

### Очистка проекта

```bash
make clean
```

Удаляет все скомпилированные Python файлы (`.pyc`, `.pyo`) и директории `__pycache__`.

### Линтинг кода

```bash
make lint
```

Проверяет форматирование и стиль кода с помощью `ruff` без внесения изменений.

### Форматирование кода

```bash
make format
```

Автоматически исправляет проблемы стиля и форматирует код с помощью `ruff`.

### Запуск тестов

#### Все тесты

```bash
make test
```

Запускает все тесты проекта с подробным выводом.

#### Тесты воспроизводимости

```bash
make test-reproducibility
```

Запускает тесты воспроизводимости экспериментов.

#### Интеграционные тесты

```bash
make test-integration
```

Запускает интеграционные тесты.

#### Тесты пайплайна

```bash
make test-pipeline
```

Запускает тесты пайплайна.

#### Тесты с покрытием

```bash
make test-coverage
```

Запускает все тесты и генерирует отчет о покрытии кода в форматах HTML и терминальном.

### Создание виртуального окружения

```bash
make create_environment
```

Создает виртуальное окружение Python 3.13 с помощью `uv`. Если окружение уже существует, пропускает создание.

**Активация окружения:**
- Windows: `.\\.venv\\Scripts\\activate`
- Unix/macOS: `source ./.venv/bin/activate`

### Настройка pre-commit хуков

```bash
make pre-commit
```

Устанавливает все pre-commit хуки (pre-commit, commit-msg, pre-push) и запускает проверки для всех файлов.

## DVC команды

### Загрузка данных из удаленного хранилища

```bash
make dvc-pull
```

Загружает данные из удаленного DVC хранилища.

### Отправка данных в удаленное хранилище

```bash
make dvc-push
```

Отправляет данные в удаленное DVC хранилище.

### Проверка статуса DVC

```bash
make dvc-status
```

Показывает статус файлов, отслеживаемых DVC.

## Интеграция и мониторинг

### Проверка здоровья сервисов

```bash
make health-check
```

Проверяет состояние всех сервисов (MLflow, MinIO, DVC, Airflow).

### Проверка здоровья сервисов (JSON)

```bash
make health-check-json
```

Проверяет состояние всех сервисов и выводит результат в формате JSON.

### Проверка интеграции

```bash
make verify-integration
```

Выполняет проверку здоровья сервисов и запускает интеграционные тесты.

### Полная проверка

```bash
make verify-all
```

Выполняет проверку здоровья сервисов и запускает все тесты.

## Docker команды

### Запуск инфраструктуры

```bash
make docker-up
```

Запускает инфраструктуру (MinIO, MLflow, Nginx) в фоновом режиме. При необходимости автоматически пересоздает Docker сеть.

### Остановка инфраструктуры

```bash
make docker-down
```

Останавливает и удаляет все контейнеры инфраструктуры.

### Просмотр логов

```bash
make docker-logs
```

Показывает логи всех контейнеров инфраструктуры в режиме реального времени.

### Перезапуск инфраструктуры

```bash
make docker-restart
```

Перезапускает все контейнеры инфраструктуры.

### Сборка Docker образов

```bash
make docker-build
```

Собирает Docker образы из `docker-compose.yml`.

### Статус инфраструктуры

```bash
make docker-status
```

Показывает статус всех контейнеров инфраструктуры.

### Пересоздание Docker сети

```bash
make docker-recreate
```

Пересоздает Docker сеть. Используйте эту команду, если возникает ошибка "network needs to be recreated".

## Airflow команды

### Исправление прав доступа к данным Airflow

```bash
make airflow-fix-permissions
```

Исправляет права доступа к данным Airflow.

### Запуск DAG

```bash
make airflow-trigger-dag
```

Запускает DAG `boston_housing_experiments` в Airflow.

### Список DAG

```bash
make airflow-list-dags
```

Показывает список всех доступных DAG в Airflow.

### Статус DAG

```bash
make airflow-dag-status
```

Показывает статус запусков DAG `boston_housing_experiments`.

## Работа с данными

### Загрузка датасета

```bash
make download-data
```

Загружает датасет из интернета. Если данные уже существуют, пропускает загрузку.

### Принудительная загрузка датасета

```bash
make download-data-force
```

Принудительно перезагружает датасет, перезаписывая существующие данные.

### Обработка датасета

```bash
make data
```

Обрабатывает датасет. Автоматически устанавливает зависимости перед выполнением.

## ML эксперименты

### Запуск экспериментов

```bash
make experiments
```

Запускает ML эксперименты. **Требует запущенный MLflow сервер.**

### Обучение в Docker контейнере

```bash
make train
```

Запускает обучение модели в Docker контейнере.

### Запуск основного приложения

```bash
make run
```

Запускает основное приложение проекта.

## Полный пайплайн экспериментов

### Полный эксперимент

```bash
make experiment-full
```

Выполняет полный цикл эксперимента:
1. Загружает данные
2. Запускает инфраструктуру
3. Ждет запуска MLflow сервера (5 секунд)
4. Запускает эксперименты

После выполнения показывает:
- MLflow UI: http://localhost:5000
- MinIO Console: http://localhost:9001
- Результаты: `data/experiments/results_summary.csv`

### Локальный эксперимент

```bash
make experiment-local
```

Запускает эксперименты без Docker. **Требует локальный или внешний MLflow сервер.**

### Демо эксперимент

```bash
make experiment-demo
```

Быстрое демо: загружает данные, запускает MLflow и запускает 4 модели для демонстрации.

## Справка

### Просмотр всех команд

```bash
make help
```

Показывает список всех доступных команд с их описаниями.

## Глобальные переменные

Makefile использует следующие глобальные переменные:

- `PROJECT_NAME = boston_housing` - имя проекта
- `PYTHON_VERSION = 3.13` - версия Python
- `PYTHON_INTERPRETER = uv run python` - интерпретатор Python

Эти переменные можно переопределить при вызове команд:

```bash
make PYTHON_VERSION=3.12 requirements
```

## Типичные сценарии использования

### Первый запуск проекта

```bash
make setup
```

### Быстрый запуск экспериментов

```bash
make quickstart
```

### Разработка: форматирование и тесты

```bash
make format
make test
```

### Проверка перед коммитом

```bash
make lint
make test
make verify-all
```

### Работа с данными

```bash
make download-data
make dvc-pull
make data
```

### Управление инфраструктурой

```bash
make docker-up      # Запуск
make docker-status  # Проверка статуса
make docker-logs    # Просмотр логов
make docker-down    # Остановка
```

## Примечания

- Все команды используют `uv run` для выполнения Python скриптов
- Docker команды требуют установленного Docker и Docker Compose
- Команды экспериментов требуют запущенный MLflow сервер (запускается через `docker-up`)
- Некоторые команды могут требовать предварительной настройки (например, DVC remote для `dvc-pull`)

## Устранение неполадок

### Проблема с Docker сетью

Если возникает ошибка "network needs to be recreated":

```bash
make docker-recreate
```

### Проблема с правами доступа Airflow

```bash
make airflow-fix-permissions
```

### Проблема с зависимостями

```bash
make clean
make requirements
```

### Проверка состояния всех сервисов

```bash
make health-check
```
